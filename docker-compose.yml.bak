version: "3.7"
services:
  puppetdb-postgres:
    image: docker.io/postgres:9.6
    hostname:
    ports:
      - "5432"
    environment:
      - POSTGRES_PASSWORD=puppetdb
      - POSTGRES_USER=puppetdb
      - POSTGRES_DB=puppetdb
    volumes:
      - volumes/puppetdb-postgres/data:/var/lib/postgresql/data/
    networks:
      puppet-foreman-network:
        aliases:
          - puppetdb-postgres
  foreman-postgres:
    image: docker.io/postgres:9.6
    hostname:
    ports:
      - "5433"
    environment:
      - POSTGRES_PASSWORD=foreman
      - POSTGRES_USER=foreman
      - POSTGRES_DB=foreman
    volumes:
      - volumes/foreman-postgres/data:/var/lib/postgresql/data/
    networks:
      puppet-foreman-network:
        aliases:
          - foreman-postgres
  pupppetserver:
    image: docker.io/luksi1/puppetserver:${puppetserver_version:?err}-foreman
    ports:
      - "8140"
    volumes:
      - volumes/code:/etc/puppetlabs/code/
      - volumes/puppet/ssl:/etc/puppetlabs/puppet/ssl/
      - volumes/puppet/serverdata:/opt/puppetlabs/server/data/puppetserver/
    networks:
      puppet-foreman-network:
        aliases:
          - puppet
  puppetdb:
    image: docker.io/puppet/puppetdb:${puppetdb_version:?err}
    ports:
      - "8080:8080"
      - "8081:8081"
   environment:
     - PUPPETDB_DATABASE_CONNECTION=//puppetdb-postgres:5432/puppetdb
    volumes:
      - volumes/puppetdb/ssl:/etc/puppetlabs/puppet/ssl/
    networks:
      puppet-foreman-network:
        aliases:
          - puppetdb
  foreman:
    image: docker.io/luksi1/foreman:latest
    ports:
      - "443:443"
    environment:
      - DATABASE_TYPE=postgresql
      - DATABASE_HOST=foreman-postgres
      - DATABASE_PORT=5433
      - DATABASE_USER=foreman
      - DATABASE_PASSWORD=foreman
      - HOSTNAME=${foreman_servername:?err}
      - DOMAIN=${domain:?err}
    volumes:
      - ${foreman_server_cert:?err}:/certs/server.crt
      - ${foreman_server_cert_key:?err}:/certs/server.key
      - ${foreman_server_cert_chain:?err}:/certs/server_cachain.pem
      - volumes/puppet/ssl/certs/ca.pem:/certs/client_ca.pem
      - volumes/puppet/ssl/ca/ca_crl.pem:/certs/client_crl.pem
      - volumes/puppet/ssl/certs/${foreman_servername:?err}.${domain:?err}.pem:/certs/client.crt
      - volumes/puppet/ssl/private_keys/${foreman_servername:?err}.${domain:?err}.pem:/certs/client.key
    networks:
      puppet-foreman-network:
        aliases:
          - ${foreman_servername:?err}
  puppet-smart-proxy:
    image: docker.io/luksi1/puppet-smart-proxy:latest
    ports:
      - "8443:8443"
    environment:
      - TRUSTED_HOSTS=${foreman_servername:?err},${foreman_servername:?err}.${domain:?err},puppet,puppet.${domain:?err}
      - PUPPET_VERSION=6.2.1
      - PUPPET_URL=https://puppet.${domain:?err}
    volumes:
      - volumes/puppet/ssl/certs/${puppet_smartproxy_servername:?err}.${domain:?err}.pem:/certs/public.crt
      - volumes/puppet/ssl/private_keys/${puppet_smartproxy_servername:?err}.${domain:?err}.pem:/certs/private.key
      - volumes/puppet/ssl/certs/ca.pem:/certs/ca.pem
    networks:
      puppet-foreman-network:
        aliases:
          - puppet-smart-proxy
  r10k:
    image: docker.io/luksi1/r10k:latest
    ports:
      - "8088:8088"
    environment:
      - CONTROL_REPO=${control_repo:?err}
    volumes:
      - volumes/code:/etc/puppetlabs/code/
    networks:
      puppet-foreman-network:
        aliases:
          - ${r10k_servername}
